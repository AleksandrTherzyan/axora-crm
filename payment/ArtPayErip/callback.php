<?php/** * Simpla CMS * * К этому скрипту обращается ArtPay в процессе оплаты * */// Работаем в корневой директорииuse Api\Simpla;chdir ('../../');$simpla = new Simpla();	if (		!$request = file_get_contents("php://input")	) {		header("HTTP/1.1 400 Bad Request");		echo 'ERROR: Нет данных!';		return 0;	}	$data = json_decode($request, true);	$ap_order_num = (int)$data['ap_order_num'];	$order = $simpla->orders->get_order($ap_order_num);	$payment_method = $simpla->payment->get_payment_method($order->payment_method_id);	$payment_settings = $simpla->payment->get_payment_settings($payment_method->id);	if (		!checkSignature($data, $payment_settings['artpay_secret2'])	) {		header("HTTP/1.1 400 Bad Request");		echo 'ERROR: Ошибка проверки подписи!';		return 0;	}	// Установим статус оплачен	$simpla->orders->update_order(intval($order->id), array('paid'=>1));	$simpla->orders->close(intval($order->id));	//$simpla->notify->email_order_user(intval($order->id));	//$simpla->notify->email_order_admin(intval($order->id));	exit;function checkSignature($data, $secret, $algo = 'sha512'){	if (!isset($data['ap_signature']))		return false;	$addSignature = $data['ap_signature'];	unset($data['ap_signature']);			uksort($data, 'strnatcmp');	$string =  implode(';', $data) . ';' . $secret;			return hash($algo, $string) == $addSignature;}